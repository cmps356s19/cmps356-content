<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        

        
        const tokenInfoUrl = 'https://www.googleapis.com/oauth2/v1/tokeninfo';
        const logoutUrl = 'http://accounts.google.com/Logout';
        
        let accessToken;
        let tokenType;
        let expiresIn;
        let user;
        let loggedIn = false;

        function login() {
            const googleConfig = {
                openIdUrl: 'https://accounts.google.com/o/oauth2/auth',
                scope: 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
                clientId: '866457396346-piq09ek9kiofq9uspsnjulv1mu1v4s8k.apps.googleusercontent.com',
                redirectUrl: 'http://localhost:3040/auth/oauth/google/callback',
                responseType: 'token'
            };

            const googleOpenIdUrl = `${googleConfig.openIdUrl}?scope=${googleConfig.scope}&client_id=${googleConfig.clientId}&redirect_uri=${googleConfig.redirectUrl}&response_type=${googleConfig.responseType}`;
            const authWindow = window.open(googleOpenIdUrl, "authWindow", 'width=800, height=600');

            const pollTimer = window.setInterval(function () {
                try {
                    console.log(authWindow.document.URL);
                    if (authWindow.document.URL.indexOf(googleConfig.redirectUrl) != -1) {
                        window.clearInterval(pollTimer);
                        const url = authWindow.document.URL;
                        console.log(url);
                        accessToken = parseQueryString(url, 'access_token');
                        tokenType = parseQueryString(url, 'token_type');
                        expiresIn = parseQueryString(url, 'expires_in');
                        authWindow.close();

                        getUserInfo(accessToken);
                    }
                } catch (e) {
                }
            }, 500);
        }


        async function getUser(accessToken) {
            console.log('accessToken', accessToken);
            const userInfoUrl = 'https://www.googleapis.com/oauth2/v1/userinfo';
            const url = `${userInfoUrl}?access_token=${accessToken}`;
            const response = await fetch(url);
            return await response.json()
        }

        async function getUserInfo(accessToken) {
            const user = await getUser(accessToken);
            console.log(user);
            $('#uName').text('Welcome ' + user.name);
            $('#imgHolder').attr('src', user.picture);
            $('#loginText').hide();
            $('#logoutText').show();

/*            $.ajax({
                url: 'https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken,
                data: null,
                success: function (resp) {
                    user = resp;
                    console.log(user);
                    $('#uName').text('Welcome ' + user.name);
                    $('#imgHolder').attr('src', user.picture);
                    $('#loginText').hide();
                    $('#logoutText').show();
                },
                dataType: "jsonp"
            });*/
        }

        //credits: http://www.netlobo.com/url_query_string_javascript.html
        function parseQueryString(url, name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            const regexS = "[\\#&]" + name + "=([^&#]*)";
            const regex = new RegExp(regexS);
            const results = regex.exec(url);
            if (results == null)
                return "";
            else
                return results[1];
        }

        function startLogoutPolling() {
            $('#loginText').show();
            $('#logoutText').hide();
            loggedIn = false;
            $('#uName').text('Welcome ');
            $('#imgHolder').attr('src', 'none.jpg');
        }

    </script>
</head>

<body>
<a href='#' onClick='login();' id="loginText"> Click here to login </a>
<a href="#" style="display:none" id="logoutText" target='myIFrame'
   onclick="myIFrame.location='https://www.google.com/accounts/Logout'; startLogoutPolling();return false;"> Click here
    to logout </a>
<iframe name='myIFrame' id="myIFrame" style='display:none'></iframe>
<div id='uName'></div>
<img src='' id='imgHolder'/>
</body>
</html>